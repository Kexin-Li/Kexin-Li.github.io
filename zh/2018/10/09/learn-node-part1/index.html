

<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  <meta name="theme-color" content="#42dbbc" />
  <meta name="msapplication-navbutton-color" content="#f8f5ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec" />

  
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
  

  <title>ZERO</title>

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">

  
    <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
  

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">

  <link rel="stylesheet" href="/css/style.css">

  

  <script>
    window.config = {"title":"ZERO","subtitle":"I Must Go Seek Some Dewdrops","description":null,"author":"likexin","language":"en-US","timezone":null,"url":"https://kexin-li.github.io","root":"/","permalink":":lang/:year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":lang/:title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":"atom-one-light","default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"cicada","deploy":{"type":"git","repo":"https://github.com/Kexin-Li/kexin-li.github.io.git","branch":"master"},"ignore":[],"keywords":null,"index_generator":{"per_page":10,"order_by":"-date","path":""},"search":{"path":"search.xml","field":"post","format":"html","limit":10000},"feed":{"type":"atom","limit":20,"hub":null,"content":null,"content_limit":140,"content_limit_delim":" ","path":"atom.xml","order_by":"-date"},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"favicon":"/images/favicon.ico","menu":{"home":"/","archives":"/archives","portfolio":"/portfolio","about":"/about"},"show_tag":true,"show_category":false,"excerpt_link":"Read More","fancybox":true,"disqus_shortname":"Shingooo","rss":"default","social":{"email":"hollalikexin@gmail.com","instagram":"https://www.instagram.com/hollalikexin/","douban":null,"linkedin":null,"weibo":null,"stackoverflow":"https://stackoverflow.com/users/6737259/kexin-li","facebook":null,"twitter":null,"github":"https://github.com/Kexin-Li","google":null,"zhihu":null,"pocket":null},"friends":null,"google_analytics":"UA-124632979-1","portfolio":{"subtitle":"Some Works","cards":{"card1":{"cover":"/images/screenshot.png","content":"Cicada is a concise and retro theme for Hexo.","link":"https://github.com/Kexin-Li/hexo-theme-cicada"},"card2":{"cover":"/images/RSpotify.png","content":"RSpotify is a Spotify Client Build with React & Redux.","link":"https://github.com/Kexin-Li/RSpotify"}}},"about":{"subtitle":"Just Another Software Engineer"},"todaypoem":false};
  </script>
</head>
  <body>
    

<header class="blog-slide" style="height: px">
  <nav class="blog-header">
    <a class="mobile toggle-button"><i class="fas fa-bars fa-lg"></i></a>
    <ul>
      <li class="title"><a href="/">ZERO</a></li>
      
        <li class="nav-item"><a href="/">Home</a></li>
      
        <li class="nav-item"><a href="/archives">Archives</a></li>
      
        <li class="nav-item"><a href="/portfolio">Portfolio</a></li>
      
        <li class="nav-item"><a href="/about">About</a></li>
      
    </ul>
  </nav>
  <h1 class="subtitle"><span id='jinrishici-sentence'>I Must Go Seek Some Dewdrops</span></h1>
</header>
    <nav id="menu">
  
    <a href="/">Home</a>
  
    <a href="/archives">Archives</a>
  
    <a href="/portfolio">Portfolio</a>
  
    <a href="/about">About</a>
  
</nav>
    
    <main class="blog-main" style="margin-top: -150px">
      <article class="blog-post">
  

  <div class="post-content">
    <div class="post-header">
      
        
  
    <h1 class="post-title">
      <a href="/zh/2018/10/09/learn-node-part1/">
        Node 初探之异步
      </a>
    </h1>
  

<div class="post-meta">
  2018-10-09
  
  
</div>

      
    </div>
    <div class="post-detail">
      
        <p>异步是指<em>现在</em>运行的程序和<em>将来</em>运行的程序中有一段时间间隙，如何处理这段时间间隙就是异步编程的核心。最简单的方法是使用回调函数。</p>
<a id="more"></a>
<p>Node 的特点有异步 IO、事件循环与回调函数和单线程。Node 的使用场景有 I/O 密集型应用、CPU 密集型应用和分布式应用。Nginx 与 Node 都是异步 I/O、事件驱动的设计理念，它们的区别是 Nginx 具备面向客户端管理连接的强大能力，它的背后依然受限于各种同步方式的编程语言。</p>
<h2 id="异步-I-O"><a href="#异步-I-O" class="headerlink" title="异步 I/O"></a>异步 I/O</h2><p>以读取文件为例，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line">fs.readFile(<span class="string">'/path'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, file</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'读取文件完成'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(‘发起读取文件’);</span><br></pre></td></tr></table></figure>
<p>“发起读取文件”是在“读取文件完成”之前输出的，而“读取文件完成”什么时候输出取决于读取文件的异步调用何时结束。“发起读取文件”可以理解为<em>现在</em>运行的程序，“读取文件完成”理解为<em>将来</em>运行的程序。</p>
<p>即异步调用为，应用程序发起了请求之后可以继续执行任务，当请求处理完毕返回数据后触发回调函数处理数据。</p>
<p><img src="quiver-image-url/180903697EEB5E579BC9E86B99BFA2A0.jpg =658x591" alt="异步调用"></p>
<p>使用异步的原因：</p>
<ul>
<li>用户体验：如果使用同步请求，那么获取资源是串行的，前面的资源获取会阻塞后面的资源获取。</li>
<li>资源分配：主流的执行任务的方式有多线程并行执行和单线程串行执行。这种方式都有其致命弊端，Node 在其中作出取舍。</li>
</ul>
<p>多线程的代价在于创建线程和执行线程上下文切换的开销较大。另外，在复杂的业务中，多线程编程经常面临锁、状态同步等问题。但是多线程在多核 CPU 上能够有效提升 CPU 的利用率。</p>
<p>单线程的顺序执行符合思考习惯，易于表达。但串行执行的缺点在于性能，任意一个略慢的任务都会阻塞后续任务的执行。在计算机资源中，通常 I/O 和 CPU 计算之间可以并行进行，但同步编程使得只能串行执行，因此资源不能得到合理利用。</p>
<p>Node 在两者中作出了调整：利用单线程，远离多线程死锁、状态同步问题；利用异步 I/O，让单线程远离阻塞，以更好地使用 CPU。为了弥补单线程无法利用多核 CPU 的缺点，Node 提供了类似前端浏览器中的 Web Worker 的子进程，child_process，该子进程可以通过工作进程高效地利用 CPU 和 I/O。</p>
<p><strong>阻塞与非阻塞</strong><br>操作系统内核对于 I/O 只有两种方式：阻塞与非阻塞。</p>
<p>在调用阻塞 I/O 时，应用程序需要等待 I/O 完成才返回结果，阻塞 I/O 的一个特点是调用之后一定要等到系统内核层面完成所有操作后，调用才结束。以读取磁盘上的一段文件为例，系统内核在完成磁盘寻道、读取数据、复制数据到内存中之后，这个调用才结束。</p>
<p>阻塞 I/O 造成 CPU 等待 I/O，浪费等待时间，CPU 的处理能力不能得到充分利用。</p>
<p>非阻塞 I/O 与阻塞 I/O 的区别是调用之后立即返回。但非阻塞 I/O 也有缺点，那就是立即返回的数据并不是业务层期望的数据，而是当前调用的状态。因此为了获取完整的数据，应用程序需要重复调用 I/O 操作来确认是否完成，这种技术叫<strong>轮询</strong>。</p>
<h3 id="Node-中的异步-I-O"><a href="#Node-中的异步-I-O" class="headerlink" title="Node 中的异步 I/O"></a>Node 中的异步 I/O</h3><p>JavaScript 引擎并不是独立存在的，而是运行在宿主环境中，比如浏览器或者 Node。JavaScript 引擎自身没有时间概念，而是按需执行 JavaScript 代码。而事件的调度(即异步的执行)是由宿主环境完成的。在 Node 中完成整个异步 I/O 环节的有<strong>事件循环</strong>、<strong>观察者</strong>和<strong>请求对象</strong>等。</p>
<p><strong>事件循环</strong><br>事件循环是一种机制，用来处理程序中多个块的执行，且执行每块时调用 JavaScript 引擎。事件循环的大体过程如下。</p>
<p>在 Node 进程启动时，Node 会创建一个类似于 <code>while(true)</code> 的循环，在这个循环中执行的过程为查看是否有事件待处理，如果有就取出事件及回调函数，如果还存在关联的回调函数，就执行它们。然后进入下个循环，直到没有事件处理了就退出循环。</p>
<p>可以用一段伪代码表示上述行为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件队列</span></span><br><span class="line"><span class="keyword">var</span> eventLoop = []; <span class="comment">// queue</span></span><br><span class="line"><span class="comment">// 事件(回调函数)</span></span><br><span class="line"><span class="keyword">var</span> event;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (eventLoop.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 读取下一个事件</span></span><br><span class="line">    event = eventLoop.shift();</span><br><span class="line">    <span class="comment">// 执行事件</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      event();</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">      reportError(err);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="quiver-image-url/B8B27ABE4E184FF15C014A4AA595B0C8.jpg =611x569" alt="事件循环"></p>
<p><strong>观察者</strong><br>观察者的作用在于在每一次循环中判断是否还有事件需要处理。每个事件循环中有一个或多个观察者，而判断是否有事件处理的过程就是向这些观察者询问是否有要处理的事件。浏览器也是类似的机制，事件可能来自于用户的点击，这些产生的事件都有对应的观察者。</p>
<p>在 Node 中，这是一个典型的<a href="https://zh.wikipedia.org/wiki/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">生产者/消费者模型</a>，事件是生产者，可能来自于异步 I/O，网络请求等，这些事件被传递到观察者那边，事件循环是消费者，它从观察者手中取出事件并执行回调函数。</p>
<p><strong>请求对象</strong><br>在 Node 中，回调函数不需要我们自己调用，而是通过请求对象来帮助我们完成调用。</p>
<p>主要的过程总结为，程序发起异步调用，将执行方法，请求参数和回调函数等封装到请求对象中，接着将请求对象放入 I/O 线程池中等待执行。到这里，JavaScript 的调用返回，JavaScript 线程可以继续执行后续任务。</p>
<p>当线程池中有可用线程时，将执行请求对象中的方法，并将执行后的结果也放在请求对象中，至此通知线程池执行完毕，将线程归还线程池。</p>
<p>接下来就是执行回调函数了。执行完成的方法被传到观察者那里，事件循环从观察者手中取出可用的请求对象，拿出回调函数和结果用于执行。于是乎，JavaScript 中传入的回调函数得到了执行。</p>
<h3 id="Node-中的非-I-O-异步-API"><a href="#Node-中的非-I-O-异步-API" class="headerlink" title="Node 中的非 I/O 异步 API"></a>Node 中的非 I/O 异步 API</h3><p>与 I/O 无关的异步 API 比如：setTimeout(), setInterval(), setImmediate(), process.nextTick()。</p>
<p><code>setTimeout()</code> 和 <code>setInterval()</code> 与浏览器中的 API 一致，分别用于单次和多次定时执行的任务。它们的实现原理和异步 I/O 类似，只是不需要 I/O 线程池的参与。</p>
<p><code>setTimeout()</code> 创建的定时器将被插入到定时器观察者内部的一颗红黑树中，每一次事件循环执行时，将从该树中取出定时器对象，检查是否已经超时，如果超时则形成一个事件放入事件循环队列中，等待宿主环境（浏览器、Node）执行它的回调函数。</p>
<p>如果队列中已经存在很多项目，那么 <code>setTimeout()</code> 的回调就将排队等候，等到执行时可能已经过了定时的时间。所以它可能存在精度不高的情况。</p>
<p><code>setInterval()</code> 和上述过程类似，区别在于重复检测和执行。</p>
<p><code>process.nextTick()</code> 常用于立即异步执行一个任务。相比于使用 <code>setTimeout(callback, 0)</code> 的方式，显得更轻量一些。后者需要动用红黑树，创建定时器对象和迭代等操作，并且存在定时器不准确的问题，而前者仅仅将回调函数放入队列，在下一轮事件循环中从队列取出执行即可。</p>
<p><code>setImmediate()</code> 和 <code>process.nextTick()</code> 类似，首要区别在于 <code>process.nextTick()</code> 的回调函数执行优先级高于 <code>setImmediate()</code>。可以用下面的例子验证：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'nextTick 延迟执行'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'setImmediate 延迟执行'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'正常执行'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行结果</span></span><br><span class="line"><span class="comment">// 正常执行</span></span><br><span class="line"><span class="comment">// nextTick 延迟执行</span></span><br><span class="line"><span class="comment">// setImmediate 延迟执行</span></span><br></pre></td></tr></table></figure>
<p>第二个区别在于 <code>process.nextTick()</code> 的回调函数保存在一个数组中，<code>setImmediate()</code> 则保存在链表中。</p>
<h2 id="异步编程"><a href="#异步编程" class="headerlink" title="异步编程"></a>异步编程</h2><p>异步编程的主要解决方法有三种：事件发布/订阅模式、Promise/Deferred 模式和流程控制库。</p>

        <hr>
      
    </div>

    
      
    

    
      
  
  
  <div class="post-tags">
    <a href="/tags/javascript/">#javascript</a> <a href="/tags/node/">#node</a>
  </div>
  <hr>
  

      <div class="post-more">
  
    <div class="post-pre">
      <span>previous</span>
      <a href="/zh/2018/10/10/learn-node-part2/">Node 初探之垃圾回收</a>
    </div>
  
  
  <div class="post-next">
    <span>next</span>
    <a href="/zh/2018/10/08/network-notes-part2/">网络基础知识备忘录(二)</a>
  </div>
  
</div>
      
  <div class="post-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </div>

    
  </div>
</article>

    </main>
    
    <div class="back-to-top" id="back-to-top"><i class="fas fa-arrow-alt-circle-up fa-2x"></i></div>

    <footer class="blog-footer">
  


  


  <div class="blog-footer-social">
    <ul>
      
        
          <li><a class="iconfont icon-email" href="mailto:hollalikexin@gmail.com"></a></li>
        
      
        
          <li><a class="iconfont icon-instagram" href="https://www.instagram.com/hollalikexin/"></a></li>
        
      
        
          <li><a class="iconfont icon-stackoverflow" href="https://stackoverflow.com/users/6737259/kexin-li"></a></li>
        
      
        
          <li><a class="iconfont icon-github" href="https://github.com/Kexin-Li"></a></li>
        
      
      
        <li><a class="iconfont icon-rss" href="/atom.xml"></a></li>
      
    </ul>
  </div>
 
  <div class="blog-footer-copyright">
  <p class="copyright">Copyright © 2018 likexin. Powered by <a href="https://hexo.io/">Hexo</a> and <a href="https://github.com/Kexin-Li/hexo-theme-cicada">Cicada</a>. <iframe src="https://ghbtns.com/github-btn.html?user=Kexin-Li&repo=hexo-theme-cicada&type=star&count=false&size=small" frameborder="0" scrolling="0" width="58px" height="30px" style="margin-bottom: -15px"></iframe></p>
</div>
</footer>

<script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>


  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>


<!--  -->


  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-124632979-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-124632979-1');
  </script>


  <script type="text/javascript">
    var disqus_shortname = 'Shingooo';
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
  </script>


<script type="text/javascript" src="/js/cicada.js"></script>
  </body>
</html>